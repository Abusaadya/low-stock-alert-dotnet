<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Low Stock Alert Settings</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            margin-right: 10px;
        }

        button,
        .button {
            background: #00b9ff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            /* For anchor tags */
            display: inline-block;
            /* For anchor tags */
            text-align: center;
            box-sizing: border-box;
        }

        button:hover,
        .button:hover {
            background: #0099d6;
        }

        .success {
            color: green;
            text-align: center;
            margin-bottom: 15px;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- New Salla Twilight Header -->
        <div class="header" style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #004d40; margin-bottom: 10px;">ğŸ“… Ù…Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>
            <p style="color: #666;">ØªØ­ÙƒÙ… ÙÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
        </div>

        <div
            style="background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-right: 4px solid #004d40; border-left: none; text-align: center;">
            <strong>Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹</strong>
            <p style="margin: 5px 0 0 0; color: #555;">
                Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¹Ø¨Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù….
            </p>
        </div>

        <form id="settingsForm">
            <input type="hidden" id="merchantId" value="">
            <input type="hidden" id="telegramChatId" value="">

            <div class="form-group">
                <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
                <input type="number" id="threshold" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 5" required>
                <small style="color: grey; display: block; margin-top: 5px;">Ø³ÙŠØµÙ„Ùƒ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯Ù…Ø§ ØªØµÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡Ø°Ø§
                    Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø£Ù‚Ù„.</small>
            </div>

            <!-- Telegram Section -->
            <div class="form-group">
                <label>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…</label>
                <div id="telegramStatus" style="margin-bottom: 10px; color: #666; font-size: 14px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                </div>

                <div id="telegramConnect" class="telegram-box">
                    <p style="margin: 0 0 10px 0;">Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ù‚Ù… Ø¨Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ØªÙ„ÙŠØ¬Ø±Ø§Ù….</p>
                    <a id="telegramLink" href="#" target="_blank" class="button telegram-btn">
                        Ø±Ø¨Ø· ØªÙ„ÙŠØ¬Ø±Ø§Ù… âœˆï¸
                    </a>
                </div>

                <div id="telegramConnected" style="display:none; text-align: center;">
                    <p style="color: #2e7d32; font-weight: bold; margin-bottom: 10px;">âœ… Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø±ØªØ¨Ø· Ø¨Ù†Ø¬Ø§Ø­</p>
                    <button type="button" id="disconnectBtn"
                        style="background: #ef5350; width: auto; font-size: 14px; padding: 8px 15px;">Ø¥Ù„ØºØ§Ø¡
                        Ø§Ù„Ø±Ø¨Ø·</button>
                </div>
            </div>

            <div class="form-group">
                <label>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="email" id="email" placeholder="email@example.com">
                <div class="checkbox-group">
                    <input type="checkbox" id="notifyEmail">
                    <label for="notifyEmail" style="margin:0; font-weight: normal;">ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                </div>
            </div>

            <div class="form-group">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ (Webhook) - (Ù„Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†)</label>
                <input type="text" id="webhook" placeholder="https://your-server.com/hook">
                <div class="checkbox-group">
                    <input type="checkbox" id="notifyWebhook">
                    <label for="notifyWebhook" style="margin:0; font-weight: normal;">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ</label>
                </div>
            </div>

            <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </form>

        <div id="statusMessage" class="status-message"></div>

        <div class="footer-links">
            <a href="/privacy" target="_blank">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
            |
            <a href="/terms" target="_blank">Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a>
        </div>
    </div>

    <script>
        // Fetch current settings on load
        async function loadSettings() {
            // Get Merchant ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const merchantId = urlParams.get('merchant');

            // If strictly enforcing identity, we might want to error here if missing.
            // But for now, we pass what we have. If null, backend returns 400.

            if (!merchantId) {
                // Initial load might not have it if testing locally without params
                console.warn("No merchant ID found in URL");
                document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±. ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø³Ù„Ø©.</p>';
                return;
            }

            try {
                const res = await fetch(`/settings/current?merchantId=${merchantId}`);
                if (res.ok) {
                    const data = await res.json();

                    document.getElementById('merchantId').value = data.merchantId;
                    document.getElementById('threshold').value = data.alertThreshold;
                    document.getElementById('email').value = data.alertEmail || '';
                    document.getElementById('notifyEmail').checked = data.notifyEmail;
                    document.getElementById('webhook').value = data.customWebhookUrl || '';
                    document.getElementById('notifyWebhook').checked = data.notifyWebhook;

                    updateTelegramUI(data.merchantId, data.telegramChatId, data.botUsername);
                } else {
                    const errText = await res.text();
                    document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${errText}</p>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ: ${err.message}</p>`;
            }
        }

        function updateTelegramUI(merchantId, telegramChatId, botUsername) {
            const statusDiv = document.getElementById('telegramStatus');
            const connectDiv = document.getElementById('telegramConnect');
            const connectedDiv = document.getElementById('telegramConnected');
            const linkBtn = document.getElementById('telegramLink');

            // Use the bot username from API, fallback to a placeholder if missing
            const finalBotName = botUsername || "SallaStockAlertBot";

            linkBtn.href = `https://t.me/${finalBotName}?start=${merchantId}`;

            if (telegramChatId) {
                const ids = telegramChatId.split(',').filter(id => id.trim().length > 0);
                const count = ids.length;

                if (count > 0) {
                    statusDiv.innerText = "";
                    connectDiv.style.display = 'none';
                    connectedDiv.style.display = 'block';
                    document.querySelector('#telegramConnected p').innerText = `âœ… Ù…Ø±ØªØ¨Ø· Ø¨Ù€ ${count} Ø­Ø³Ø§Ø¨(Ø§Øª) ØªÙ„ÙŠØ¬Ø±Ø§Ù…`;
                    document.getElementById('telegramChatId').value = telegramChatId;
                } else {
                    showConnect();
                }
            } else {
                showConnect();
            }

            function showConnect() {
                statusDiv.innerText = "";
                connectDiv.style.display = 'block';
                connectedDiv.style.display = 'none';
                document.getElementById('telegramChatId').value = "";
            }
        }

        document.getElementById('disconnectBtn').addEventListener('click', async () => {
            const mid = document.getElementById('merchantId').value;
            try {
                const res = await fetch('/settings/telegram/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merchantId: mid })
                });
                if (res.ok) {
                    document.getElementById('statusMessage').innerHTML = '<p class="success">Telegram Disconnected. âœ…</p>';
                    document.getElementById('telegramChatId').value = '';
                    updateTelegramUI(mid, null, null);
                } else {
                    document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Error disconnecting Telegram</p>';
                }
            } catch (err) {
                document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Network error: ${err.message}</p>`;
            }
        });

        loadSettings();

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const midStr = document.getElementById('merchantId').value;
            // Validate Merchant ID
            if (!midStr) {
                document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„ØªØ§Ø¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.</p>';
                return;
            }

            const data = {
                MerchantId: parseInt(midStr),
                AlertThreshold: parseInt(document.getElementById('threshold').value),
                AlertEmail: document.getElementById('email').value,
                CustomWebhookUrl: document.getElementById('webhook').value,
                TelegramChatId: document.getElementById('telegramChatId').value || null,
                NotifyEmail: document.getElementById('notifyEmail').checked,
                NotifyWebhook: document.getElementById('notifyWebhook').checked
            };

            try {
                const res = await fetch('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.getElementById('statusMessage').innerHTML = '<p class="success">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! âœ…</p>';
                } else {
                    document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>';
                }
            } catch (err) {
                document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message}</p>`;
            }
        });
    </script>
</body>

</html>