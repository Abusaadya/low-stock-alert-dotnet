<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Low Stock Alert Settings</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            margin-right: 10px;
        }

        button,
        .button {
            background: #00b9ff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            /* For anchor tags */
            display: inline-block;
            /* For anchor tags */
            text-align: center;
            box-sizing: border-box;
        }

        button:hover,
        .button:hover {
            background: #0099d6;
        }

        .success {
            color: green;
            text-align: center;
            margin-bottom: 15px;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- New Salla Twilight Header -->
        <div class="header" style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #004d40; margin-bottom: 10px;">ğŸ“… Ù…Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>
            <p style="color: #666;">ØªØ­ÙƒÙ… ÙÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
        </div>

        <div
            style="background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-right: 4px solid #004d40; border-left: none; text-align: center;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</strong>
                <span id="planBadge"
                    style="background: #ffab00; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">Ø¬Ø§Ø±ÙŠ
                    Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>

            <div style="font-size: 13px; color: #555; text-align: right; margin-bottom: 5px;">
                <span id="usageText">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª: 0 / 0</span>
                <div style="background: #b2dfdb; height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                    <div id="usageBar" style="background: #00796b; height: 100%; width: 0%;"></div>
                </div>
            </div>
            <div style="font-size: 13px; color: #555; text-align: right;">
                <span id="telegramUsageText">Ø­Ø³Ø§Ø¨Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…: 0 / 0</span>
            </div>

            <p id="trialExpiry" style="margin: 10px 0 0 0; color: #d32f2f; font-size: 11px; display:none;"></p>

            <a href="https://salla.sa/site/apps" target="_blank" id="upgradeBtn"
                style="display:none; margin-top: 15px; background: #2e7d32; color: white; text-decoration: none; padding: 5px 15px; border-radius: 15px; font-size: 12px;">
                ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨Ø§Ù‚Ø© â­
            </a>
        </div>

        <form id="settingsForm">
            <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                <label style="color: #004d40;">Ø§Ù„Ù…ØªØ¬Ø±</label>
                <div style="direction: rtl; margin-bottom: 5px; font-weight: bold; color: #2E7D32; font-size: 20px;"
                    id="displayName"></div>
                <input type="text" id="displayMerchantId" readonly
                    style="text-align: center; background: #eee; border: none; font-size: 14px; color: #666;"
                    value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...">
                <input type="hidden" id="merchantId" value="">
            </div>
            <input type="hidden" id="telegramChatId" value="">

            <div class="form-group">
                <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
                <input type="number" id="threshold" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 5" required>
                <small style="color: grey; display: block; margin-top: 5px;">Ø³ÙŠØµÙ„Ùƒ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯Ù…Ø§ ØªØµÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡Ø°Ø§
                    Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø£Ù‚Ù„.</small>
            </div>

            <!-- Telegram Section -->
            <div class="form-group">
                <label>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…</label>
                <div id="telegramStatus" style="margin-bottom: 10px; color: #666; font-size: 14px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                </div>

                <!-- Bot Initialization Button -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button type="button" id="initBotBtn"
                        style="background: #607d8b; font-size: 13px; padding: 5px 15px; width: auto; border-radius: 20px;">
                        âš™ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª (Ø§Ø¶ØºØ· Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
                    </button>
                    <p id="initMsg" style="font-size: 11px; color: #888; margin-top: 5px;"></p>
                </div>

                <div id="telegramConnect" class="telegram-box">
                    <p style="margin: 0 0 10px 0;">Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ù‚Ù… Ø¨Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ØªÙ„ÙŠØ¬Ø±Ø§Ù….</p>
                    <a id="telegramLink" href="#" target="_blank" class="button telegram-btn">
                        Ø±Ø¨Ø· ØªÙ„ÙŠØ¬Ø±Ø§Ù… âœˆï¸
                    </a>
                </div>

                <div id="telegramConnected" style="display:none; text-align: center;">
                    <p style="color: #2e7d32; font-weight: bold; margin-bottom: 10px;">âœ… Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø±ØªØ¨Ø· Ø¨Ù†Ø¬Ø§Ø­</p>
                    <button type="button" id="disconnectBtn"
                        style="background: #ef5350; width: auto; font-size: 14px; padding: 8px 15px;">Ø¥Ù„ØºØ§Ø¡
                        Ø§Ù„Ø±Ø¨Ø·</button>
                </div>
            </div>

            <div class="form-group">
                <label>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="email" id="email" placeholder="email@example.com">
                <div class="checkbox-group">
                    <input type="checkbox" id="notifyEmail">
                    <label for="notifyEmail" style="margin:0; font-weight: normal;">ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                </div>
            </div>

            <div class="form-group">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ (Webhook) - (Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†)</label>
                <input type="text" id="webhook" placeholder="https://your-server.com/hook">
                <div class="checkbox-group">
                    <input type="checkbox" id="notifyWebhook">
                    <label for="notifyWebhook" style="margin:0; font-weight: normal;">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ</label>
                </div>
            </div>

            <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </form>

        <div id="statusMessage" class="status-message"></div>

        <div class="footer-links text-center">
            <a href="/privacy" target="_blank">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
            |
            <a href="/terms" target="_blank">Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a>
        </div>
    </div>

    <script>
        // Fetch current settings on load
        async function loadSettings() {
            // Get Merchant ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const merchantId = urlParams.get('merchant');

            // If strictly enforcing identity, we might want to error here if missing.
            // But for now, we pass what we have. If null, backend returns 400.

            if (!merchantId) {
                // Initial load might not have it if testing locally without params
                console.warn("No merchant ID found in URL");
                document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±. ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø³Ù„Ø©.</p>';
                return;
            }

            try {
                const res = await fetch(`/settings/current?merchantId=${merchantId}`);
                if (res.ok) {
                    const data = await res.json();

                    document.getElementById('merchantId').value = data.merchantId;
                    document.getElementById('displayMerchantId').value = '#' + data.merchantId;
                    document.getElementById('displayName').innerText = data.name || "Ù…ØªØ¬Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                    document.getElementById('threshold').value = data.alertThreshold;
                    document.getElementById('email').value = data.alertEmail || '';
                    document.getElementById('notifyEmail').checked = data.notifyEmail;
                    document.getElementById('webhook').value = data.customWebhookUrl || '';
                    document.getElementById('notifyWebhook').checked = data.notifyWebhook;

                    updateTelegramUI(data.merchantId, data.telegramChatId, data.botUsername);
                    updateSubscriptionUI(data.subscription);
                } else {
                    const errText = await res.text();
                    document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${errText}</p>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ: ${err.message}</p>`;
            }
        }

        function updateTelegramUI(merchantId, telegramChatId, botUsername) {
            const statusDiv = document.getElementById('telegramStatus');
            const connectDiv = document.getElementById('telegramConnect');
            const connectedDiv = document.getElementById('telegramConnected');
            const linkBtn = document.getElementById('telegramLink');

            // Use the bot username from API, fallback to a placeholder if missing
            const finalBotName = botUsername || "SallaStockAlertBot";

            linkBtn.href = `https://t.me/${finalBotName}?start=${merchantId}`;

            // Initialize Bot Button Logic
            document.getElementById('initBotBtn').onclick = async () => {
                const btn = document.getElementById('initBotBtn');
                const msg = document.getElementById('initMsg');
                btn.disabled = true;
                btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„...";

                try {
                    const res = await fetch('/telegram/setup', { method: 'POST' });
                    if (res.ok) {
                        msg.innerText = "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø±Ø¨Ø·.";
                        msg.style.color = "green";
                        btn.style.display = "none";
                    } else {
                        msg.innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                        msg.style.color = "red";
                        btn.disabled = false;
                        btn.innerText = "âš™ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª";
                    }
                } catch (e) {
                    msg.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.";
                    btn.disabled = false;
                }
            };

            if (telegramChatId) {
                const ids = telegramChatId.split(',').filter(id => id.trim().length > 0);
                const count = ids.length;

                if (count > 0) {
                    statusDiv.innerText = "";
                    // Show both connected status AND the link allows adding more
                    connectDiv.style.display = 'block';
                    document.querySelector('#telegramConnect p').innerText = "Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±ØŒ Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:";
                    document.getElementById('telegramLink').innerText = "ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¨Ø·";
                    // Change link behavior to copy to clipboard instead of opening
                    document.getElementById('telegramLink').onclick = (e) => {
                        e.preventDefault();
                        navigator.clipboard.writeText(linkBtn.href).then(() => {
                            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„Ù„Ù…ÙˆØ¸Ù Ù„ÙŠØ±Ø¨Ø· Ø­Ø³Ø§Ø¨Ù‡.");
                        });
                    };

                    connectedDiv.style.display = 'block';
                    document.querySelector('#telegramConnected p').innerText = `âœ… Ù…Ø±ØªØ¨Ø· Ø¨Ù€ ${count} Ø­Ø³Ø§Ø¨(Ø§Øª) ØªÙ„ÙŠØ¬Ø±Ø§Ù…`;
                    document.getElementById('telegramChatId').value = telegramChatId;
                } else {
                    showConnect();
                }
            } else {
                showConnect();
            }

            function showConnect() {
                statusDiv.innerText = "";
                connectDiv.style.display = 'block';
                document.querySelector('#telegramConnect p').innerText = "Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ù‚Ù… Ø¨Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ØªÙ„ÙŠØ¬Ø±Ø§Ù….";
                document.getElementById('telegramLink').innerText = "Ø±Ø¨Ø· ØªÙ„ÙŠØ¬Ø±Ø§Ù… âœˆï¸";
                document.getElementById('telegramLink').onclick = null; // Reset click handler

                connectedDiv.style.display = 'none';
                document.getElementById('telegramChatId').value = "";
            }
        }

        function updateSubscriptionUI(sub) {
            if (!sub) return;

            const badge = document.getElementById('planBadge');
            const usageText = document.getElementById('usageText');
            const usageBar = document.getElementById('usageBar');
            const telegramUsageText = document.getElementById('telegramUsageText');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const trialExpiry = document.getElementById('trialExpiry');

            // Plan Names
            const plans = ["Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© â³", "Ø¨Ø§Ù‚Ø© Ø£Ø³Ø§Ø³ÙŠØ© ğŸ¥‰", "Ø¨Ø§Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© ğŸ†"];
            badge.innerText = plans[sub.planType];

            // Colors
            if (sub.planType === 0) badge.style.background = "#ffab00"; // Orange
            if (sub.planType === 1) badge.style.background = "#29b6f6"; // Blue
            if (sub.planType === 2) badge.style.background = "#ffd700"; // Gold

            // Usage
            let alertLimit = sub.maxAlertsPerMonth;
            let currentAlerts = sub.alertsSentThisMonth;
            if (alertLimit > 100000) alertLimit = "ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯";

            usageText.innerText = `Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª: ${currentAlerts} / ${alertLimit}`;

            if (typeof alertLimit === 'number') {
                const percent = Math.min(100, (currentAlerts / alertLimit) * 100);
                usageBar.style.width = percent + "%";
                if (percent > 90) usageBar.style.background = "#d32f2f"; // Red warning
            } else {
                usageBar.style.width = "100%"; // Full bar for unlimited
                usageBar.style.background = "#4caf50";
            }

            // Telegram Accounts Limit
            let telegramLimit = sub.maxTelegramAccounts;
            if (telegramLimit > 100) telegramLimit = "ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯";

            // Calculate connected accounts from hidden field or whatever exists
            const existingIds = document.getElementById('telegramChatId').value;
            const connectedCount = existingIds ? existingIds.split(',').filter(id => id.trim().length > 0).length : 0;

            telegramUsageText.innerHTML = `Ø­Ø³Ø§Ø¨Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…: <b>${connectedCount}</b> / ${telegramLimit}`;

            // Trial Expiry
            if (sub.planType === 0 && sub.trialEndsAt) {
                const endDate = new Date(sub.trialEndsAt);
                const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                trialExpiry.innerText = `ØªÙ†ØªÙ‡ÙŠ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø®Ù„Ø§Ù„ ${daysLeft} ÙŠÙˆÙ…`;
                trialExpiry.style.display = 'block';
                upgradeBtn.style.display = 'inline-block';
            }
        }

        document.getElementById('disconnectBtn').addEventListener('click', async () => {
            const mid = document.getElementById('merchantId').value;
            try {
                const res = await fetch('/settings/telegram/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merchantId: mid })
                });
                if (res.ok) {
                    document.getElementById('statusMessage').innerHTML = '<p class="success">Telegram Disconnected. âœ…</p>';
                    document.getElementById('telegramChatId').value = '';
                    updateTelegramUI(mid, null, null);
                } else {
                    document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Error disconnecting Telegram</p>';
                }
            } catch (err) {
                document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Network error: ${err.message}</p>`;
            }
        });

        loadSettings();

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const midStr = document.getElementById('merchantId').value;
            // Validate Merchant ID
            if (!midStr) {
                document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„ØªØ§Ø¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.</p>';
                return;
            }

            const data = {
                MerchantId: parseInt(midStr),
                AlertThreshold: parseInt(document.getElementById('threshold').value),
                AlertEmail: document.getElementById('email').value,
                CustomWebhookUrl: document.getElementById('webhook').value,
                TelegramChatId: document.getElementById('telegramChatId').value || null,
                NotifyEmail: document.getElementById('notifyEmail').checked,
                NotifyWebhook: document.getElementById('notifyWebhook').checked
            };

            try {
                const res = await fetch('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.getElementById('statusMessage').innerHTML = '<p class="success">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! âœ…</p>';
                } else {
                    document.getElementById('statusMessage').innerHTML = '<p style="color:red;">Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>';
                }
            } catch (err) {
                document.getElementById('statusMessage').innerHTML = `<p style="color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message}</p>`;
            }
        });
    </script>
</body>

</html>