<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Low Stock Alert Settings</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            margin-right: 10px;
        }

        button {
            background: #00b9ff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #0099d6;
        }

        .success {
            color: green;
            text-align: center;
            margin-bottom: 15px;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”” Alert Settings</h1>

        <div
            style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
            <strong>Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹</strong>
            <p style="margin: 10px 0 0 0; color: #555;">
                Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.
            </p>
        </div>

        <!-- Placeholder for messages -->
        <div class="header">
            <h1>ğŸ“… Ù…Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>
            <p>ØªØ­ÙƒÙ… ÙÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
        </div>

        <form id="settingsForm">
            <input type="hidden" id="merchantId" value="">
            <input type="hidden" id="telegramChatId" value="">

            <div class="form-group">
                <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
                <input type="number" id="threshold" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 5" required>
                <small style="color: grey; display: block; margin-top: 5px;">Ø³ÙŠØµÙ„Ùƒ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯Ù…Ø§ ØªØµÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡Ø°Ø§
                    Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø£Ù‚Ù„.</small>
            </div>

            <!-- Telegram Section -->
            <div class="form-group">
                <label>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…</label>
                <div id="telegramStatus" style="margin-bottom: 10px; color: #666; font-size: 14px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                </div>

                <div id="telegramConnect" class="telegram-box">
                    <p style="margin: 0 0 10px 0;">Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ù‚Ù… Ø¨Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ØªÙ„ÙŠØ¬Ø±Ø§Ù….</p>
                    <a id="telegramLink" href="#" target="_blank" class="button telegram-btn">
                        Ø±Ø¨Ø· ØªÙ„ÙŠØ¬Ø±Ø§Ù… âœˆï¸
                    </a>
                </div>

                <div id="telegramConnected" style="display:none; text-align: center;">
                    <p style="color: #2e7d32; font-weight: bold; margin-bottom: 10px;">âœ… Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø±ØªØ¨Ø· Ø¨Ù†Ø¬Ø§Ø­</p>
                    <button type="button" id="disconnectBtn"
                        style="background: #ef5350; width: auto; font-size: 14px; padding: 8px 15px;">Ø¥Ù„ØºØ§Ø¡
                        Ø§Ù„Ø±Ø¨Ø·</button>
                </div>
            </div>

            <div class="form-group">
                <label>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="email" id="email" placeholder="email@example.com">
                <div class="checkbox-group">
                    <input type="checkbox" id="notifyEmail">
                    <label for="notifyEmail" style="margin:0; font-weight: normal;">ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                </div>
            </div>

            <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </form>

        <div id="statusMessage" class="status-message"></div>

        <div class="footer-links">
            <a href="/privacy" target="_blank">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
            |
            <a href="/terms" target="_blank">Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a>
        </div>
    </div>

    <script>
        // Fetch current settings on load
        async function loadSettings() {
            try {
                const res = await fetch('/settings/current');
                if (res.ok) {
                    const data = await res.json();

                    document.getElementById('merchantId').value = data.merchantId;
                    document.getElementById('threshold').value = data.alertThreshold;
                    document.getElementById('email').value = data.alertEmail || '';
                    document.getElementById('notifyEmail').checked = data.notifyEmail;
                    document.getElementById('webhook').value = data.customWebhookUrl || '';
                    document.getElementById('notifyWebhook').checked = data.notifyWebhook;
                    document.getElementById('telegramChatId').value = data.telegramChatId || ''; // Store for submission

                    // Telegram Logic
                    const botUsername = "SallaStockAlertBot"; // REPLACE WITH YOUR BOT USERNAME IF DIFFERENT, OR FETCH FROM API
                    /* Note: Since we don't have the bot username in the API response yet, 
                       we will rely on hardcoding it or passing it. 
                       Ideally the API should return it. 
                       For now, I will assume a generic placeholder or ask user to update it.
                       Actually, I'll use the one I asked the user to create 'SallaStockAlertBot' but they might have chosen another.
                       It's safer to just provide the link to the bot ID? No, username is needed for link.
                       Let's assume the user sends the username or we make a best guess.
                       Actually, I can just use the provided token to 'getMe' to find the username.
                       But for now, I'll update the link dynamically.*/

                    updateTelegramUI(data.merchantId, data.telegramChatId);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function updateTelegramUI(merchantId, telegramChatId) {
            const statusDiv = document.getElementById('telegramStatus');
            const connectDiv = document.getElementById('telegramConnect');
            const connectedDiv = document.getElementById('telegramConnected');
            const linkBtn = document.getElementById('telegramLink');

            // Hardcoded bot username for now - IDEALLY should come from backend config
            // The user's bot token was for a bot. I entered it.
            // I should probably fetch the bot info in the backend and return the username.
            // But to save roundtrips, I will use a placeholder or ask user to fill it.
            // BETTER: Use a backend endpoint to get the bot link.

            // For this iteration, I'll assume the merchant needs to search for the bot if I don't know the name.
            // BUT wait, deep linking requires the username. t.me/USERNAME?start=...

            if (telegramChatId) {
                statusDiv.innerText = "Status: Connected";
                connectDiv.style.display = 'none';
                connectedDiv.style.display = 'block';
            } else {
                statusDiv.innerText = "Status: Not Connected";
                connectDiv.style.display = 'block';
                connectedDiv.style.display = 'none';

                // We need the bot username. I will add a TODO or just omit the username and ask user to search.
                // Or better, I'll add an endpoint to get the bot link.
                // TEMPORARY: I will use a generic link structure that likely needs update.
                // Actually, I can use the 'getMe' endpoint in backend to cache it.
                // For now, I'll create a link to a placeholder and ask the user to update the HTML or I'll implement a 'GetBotInfo' endpoint. 
                // For now, let's assume the bot username is known or fetched.
                // The deep link should be t.me/<bot_username>?start=<merchantId>
                // For this example, I'll use a placeholder bot username.
                const botUsername = "SallaStockAlertBot"; // This should ideally come from the backend
                linkBtn.href = `https://t.me/${botUsername}?start=${merchantId}`;
            }
        }

        document.getElementById('disconnectBtn').addEventListener('click', async () => {
            // Logic to clear telegram ID (simple POST)
            const mid = document.getElementById('merchantId').value;
            try {
                const res = await fetch('/settings/telegram/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merchantId: mid })
                });
                if (res.ok) {
                    document.getElementById('message').innerHTML = '<p class="success">Telegram Disconnected. âœ…</p>';
                    document.getElementById('telegramChatId').value = ''; // Clear hidden field
                    updateTelegramUI(mid, null); // Update UI to disconnected state
                } else {
                    alert('Error disconnecting Telegram');
                }
            } catch (err) {
                alert('Network error during disconnect');
            }
        });

        loadSettings();

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                MerchantId: parseInt(document.getElementById('merchantId').value),
                AlertThreshold: parseInt(document.getElementById('threshold').value),
                AlertEmail: document.getElementById('email').value,
                CustomWebhookUrl: document.getElementById('webhook').value,
                TelegramChatId: document.getElementById('telegramChatId').value || null, // Preserve existing or send null if not connected
                NotifyEmail: document.getElementById('notifyEmail').checked,
                NotifyWebhook: document.getElementById('notifyWebhook').checked
            };

            try {
                const res = await fetch('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.getElementById('message').innerHTML = '<p class="success">Settings Saved Successfully! âœ…</p>';
                } else {
                    alert('Error saving settings');
                }
            } catch (err) {
                alert('Network error');
            }
        });
    </script>
</body>

</html>